---
lab:
  title: 使用逻辑解码列出表更改
  module: Understand write-ahead logging
---

# 使用逻辑解码列出表更改

在本练习中，你将配置逻辑复制，这是 PostgreSQL 的本机复制。 将创建两个服务器，充当发布服务器和订阅服务器。 zoodb 中的数据将在它们之间复制。

## 开始之前

需要有自己的 Azure 订阅才能完成本练习。 如果还没有 Azure 订阅，可以创建一个 [Azure 免费试用版](https://azure.microsoft.com/free)。

## 创建资源组

1. 登录到 Azure 门户。 用户帐户必须是 Azure 订阅的所有者或参与者。
1. 选择“资源组”，然后选择“+ 创建”。
1. 选择订阅。
1. 在资源组中，输入 **rg-PostgreSQL_Replication**。
1. 选择靠近你所在位置的区域。
1. 选择“查看 + 创建”。
1. 选择“创建”。

## 创建发布服务器

1. 在“Azure 服务”下，选择“+ 创建资源”。 在“类别”下，选择“数据库”。 在“Azure Database for PostgreSQL”下，选择“创建”。
1. 在灵活服务器“基本信息”选项卡上，输入每个字段，如下所示：
    1. 订阅 - 你的订阅。
    1. 资源组 - 选择“**rg-PostgreSQL_Replication**”。
    1. 服务器名称 - **psql-postgresql-pub9999**（名称必须是全局唯一的，因此请将 9999 替换为随机数）。
    1. 区域 - 选择与资源组相同的区域。
    1. PostgreSQL 版本 - 选择“16”。
    1. 工作负载类型 - 开发。
    1. 计算 + 存储 - 可突发。 选择“配置服务器”并检查配置选项。 请勿进行任何更改并关闭该部分。
    1. 可用性区域 - 1。 如果不支持可用性区域，请保留为“无首选项”。
    1. 高可用性 - 禁用的。
    1. 身份验证方法 - 仅限 PostgreSQL 身份验证
    1. 在**管理员用户名**中，输入**`demo`**。
    1. 在**密码**中，输入合适的复杂密码。
    1. 选择“下一步: 网络 >”****。
1. 在灵活服务器“网络”选项卡上，输入每个字段，如下所示：
    1. 连接方法：(o) 公共访问（允许的 IP 地址）。
    1. 允许从 Azure 内的任何 Azure 服务公开访问此服务器 - 已选中。 必须选中此选项，以便发布服务器和订阅服务器数据库可以相互通信。
    1. 在“防火墙规则”下，选择“+ 添加当前客户端 IP 地址”。 这会将当前 IP 地址添加为防火墙规则。 可以选择为此防火墙规则指定一个有意义的名称。
1. 选择“查看 + 创建”。 然后选择“创建”。
1. 由于创建 Azure Database for PostgreSQL 可能需要几分钟时间，因此请在进行部署时立即开始下一步。 请记得打开新的浏览器窗口或选项卡以继续。

## 创建订阅服务器

1. 在“Azure 服务”下，选择“+ 创建资源”。 在“类别”下，选择“数据库”。 在“Azure Database for PostgreSQL”下，选择“创建”。
1. 在灵活服务器“基本信息”选项卡上，输入每个字段，如下所示：
    1. 订阅 - 你的订阅。
    1. 资源组 - 选择“**rg-PostgreSQL_Replication**”。
    1. 服务器名称 - **psql-postgresql-sub9999**（名称必须是全局唯一的，因此请将 9999 替换为随机数）。
    1. 区域 - 选择与资源组相同的区域。
    1. PostgreSQL 版本 - 选择“16”。
    1. 工作负载类型 - 开发。
    1. 计算 + 存储 - 可突发。 选择“配置服务器”并检查配置选项。 请勿进行任何更改并关闭该部分。
    1. 可用性区域 - 2。 如果不支持可用性区域，请保留为“无首选项”。
    1. 高可用性 - 禁用的。
    1. 身份验证方法 - 仅限 PostgreSQL 身份验证
    1. 在**管理员用户名**中，输入**`demo`**。
    1. 在**密码**中，输入合适的复杂密码。
    1. 选择“下一步: 网络 >”****。
1. 在灵活服务器“网络”选项卡上，输入每个字段，如下所示：
    1. 连接方法：(o) 公共访问（允许的 IP 地址）
    1. 允许从 Azure 内的任何 Azure 服务公开访问此服务器 - 已选中。 必须选中此选项，以便发布服务器和订阅服务器数据库可以相互通信。
    1. 在“防火墙规则”下，选择“+ 添加当前客户端 IP 地址”。 这会将当前 IP 地址添加为防火墙规则。 可以选择为此防火墙规则指定一个有意义的名称。
1. 选择“查看 + 创建”。 然后选择“创建”。
1. 等待部署这两个 Azure Database for PostgreSQL 服务器。

## 设置复制

对于这*两个*发布服务器和订阅服务器：

1. 在 Azure 门户中，导航到服务器，并在“设置”下选择“服务器参数”。
1. 使用搜索栏查找每个参数并进行以下更改：
    1. `wal_level` = LOGICAL
    1. `max_worker_processes` = 24
1. 选择“保存”。 然后选择“保存并重启”。
1. 等待两个服务器重启。

    > 注意
    >
    > 重新部署服务器后，可能需要刷新浏览器窗口才能注意到服务器已重启。

## 在继续之前

确保已完成以下操作：

1. 你已安装并启动两个 Azure Database for PostgreSQL 灵活服务器。
1. 你已经从 [PostgreSQL 实验室](https://github.com/MicrosoftLearning/mslearn-postgresql.git)克隆了实验室脚本。 如果尚未执行此操作，请在本地克隆存储库：
    1. 打开命令行/终端。
    1. 运行以下命令：
       ```bash
       md .\DP3021Lab
       git clone https://github.com/MicrosoftLearning/mslearn-postgresql.git .\DP3021Lab
       ```
       > 注意
       > 
       > 如果未安装 **git** ， [请下载并安装 ***git*** 应用](https://git-scm.com/download) ，然后再次尝试运行上述命令。
1. 你已安装 Azure Data Studio。 如果尚未 [下载并安装 ***Azure Data Studio***](https://go.microsoft.com/fwlink/?linkid=2282284)。
1. 在 Azure Data Studio 中安装 **PostgreSQL** 扩展。

## 设置发布服务器

1. 打开 Azure Data Studio 并连接到发布服务器。 （从“概述”部分复制服务器名称。）
1. 选择 **文件**、**打开文件**，然后导航到保存脚本的文件夹。
1. 打开脚本 **../Allfiles/Labs/06/Lab6_Replication.sql** 并连接到服务器。
1. 突出显示并运行“授予管理员用户复制权限”部分。
1. 突出显示并运行“创建 zoodb 数据库”部分。
1. 使用工具栏上的下拉列表选择 zoodb 作为当前数据库。 通过运行 SELECT 语句验证 zoodb 是否为当前数据库。
1. 突出显示并运行 zoodb 中的 **创建表** 和 **外键约束** 部分。
1. 突出显示并运行“填充 zoodb 中的表”部分。
1. 突出显示并运行“创建发布”部分。 运行 SELECT 语句时，它不会列出任何内容，因为复制尚未处于活动状态。

## 设置订阅者

1. 打开 Azure Data Studio 的第二个实例并连接到订阅服务器。
1. 选择 **文件**、**打开文件**，然后导航到保存脚本的文件夹。
1. 打开脚本 **../Allfiles/Labs/06/Lab6_Replication.sql** 并连接到订阅服务器。 （从“概述”部分复制服务器名称。）
1. 突出显示并运行“授予管理员用户复制权限”部分。
1. 突出显示并运行“创建 zoodb 数据库”部分。
1. 使用工具栏上的下拉列表选择 zoodb 作为当前数据库。 通过运行 SELECT 语句验证 zoodb 是否为当前数据库。
1. 突出显示并运行 zoodb 中的 **创建表** 和 **外键约束** 部分。
1. 向下滚动到“创建订阅”部分。
    1. 编辑 **创建订阅** 语句，使其包含正确的发布服务器名称和发布者的强密码。 突出显示并运行语句。
    1. 突出显示并运行 SELECT 语句。 这会显示已创建的订阅“sub”。
1. 在“显示表”部分下，突出显示并运行每个 SELECT 语句。 表已通过发布服务器的复制进行填充。

## 对发布服务器数据库进行更改

- 在 Azure Data Studio 的第一个实例（*发布实例*）中，在“**插入更多动物**”下突出显示并运行 **INSERT** 语句。 *请确保 **不要** 在订阅者*运行此 INSERT 语句。

## 查看订阅服务器数据库中的更改

- 在 Azure Data Studio（订阅服务器）的第二个实例中，在“显示动物表”下突出显示并运行 SELECT 语句。

现已创建两个 Azure Database for PostgreSQL 灵活服务器，并将一个服务器配置为发布服务器，将另一个服务器配置为订阅服务器。 在发布服务器数据库中，你创建并填充了 zoo 数据库。 在订阅服务器数据库中，你创建了一个空数据库，然后通过流式处理复制填充该数据库。

## 清理

1. 完成练习后，删除包含这两个服务器的资源组。 除非停止或删除服务器，否则将向你收取费用。
1. 如果需要，请删除 .\DP3021Lab 文件夹。
