---
lab:
  title: 使用逻辑解码列出表更改
  module: Understand write-ahead logging
---

# 使用逻辑解码列出表更改

在本练习中，我们配置 PostgreSQL 原生的逻辑复制。 我们创建两个服务器，充当发布服务器和订阅服务器。 zoodb 中的数据在它们之间复制。

## 开始之前

需要有自己的 Azure 订阅才能完成本练习。 如果还没有 Azure 订阅，可以创建一个 [Azure 免费试用版](https://azure.microsoft.com/free)。

此外，需要在计算机上安装以下软件：

- Visual Studio Code。
- Microsoft Postgres Visual Studio Code 扩展。
- Azure CLI。
- Git。

## 创建练习环境

在本练习及以后的练习中，将使用 Bicep 脚本将 Azure Database for PostgreSQL - 灵活服务器和其他资源部署到 Azure 订阅中。 Bicep 脚本位于之前克隆的 GitHub 存储库的 `/Allfiles/Labs/Shared` 文件夹中。

### 下载并安装 Visual Studio Code 和 PostgreSQL 扩展

如果未安装 Visual Studio Code：

1. 在浏览器中，导航到“[下载 Visual Studio Code](https://code.visualstudio.com/download)”，并选择适合操作系统的版本。

1. 按照操作系统的安装说明进行操作。

1. 打开 Visual Studio Code。

1. 在左侧菜单中，选择“扩展”以显示“扩展”面板。

1. 在搜索栏中，输入“PostgreSQL”。 将显示“Visual Studio Code 的 PostgreSQL 扩展”图标。 请确保选择 Microsoft 的产品。

1. 选择“安装”  。 扩展安装。

### 下载并安装 Azure CLI 和 Git

如果没有安装 Azure CLI 或 Git：

1. 在浏览器中，导航到“[安装 Azure CLI](https://learn.microsoft.com/cli/azure/install-azure-cli)”，并按照操作系统的说明进行操作。

1. 在浏览器中，导航到“[下载并安装 Git](https://git-scm.com/downloads)”，并按照操作系统的说明进行操作。

### 下载练习文件

如果已克隆包含练习文件的 GitHub 存储库，*请跳过下载练习文件*。

要下载练习文件，请将包含练习文件的 GitHub 存储库克隆到本地计算机。 存储库包含完成本练习所需的所有脚本和资源。

1. 打开 Visual Studio Code（如果尚未打开）。

1. 选择“**显示所有命令**” (Ctrl+Shift+P)，以打开命令面板。

1. 在命令面板中，搜索并选择“**Git：克隆**”。

1. 在命令面板中，输入以下内容以克隆包含练习资源的 GitHub 存储库，然后按 **Enter**：

    ```bash
    https://github.com/MicrosoftLearning/mslearn-postgresql.git
    ```

1. 按照提示选择要克隆存储库的文件夹。 存储库克隆到所选位置中命名为 `mslearn-postgresql` 的文件夹。

1. 当系统询问你是否要打开克隆的存储库时，选择“打开”。 在 Visual Studio Code 中打开存储库。

## 创建资源组

在本部分中，你将创建一个资源组，以包含 Azure Database for PostgreSQL 服务器。 资源组是一种逻辑容器，用于管理 Azure 解决方案的相关资源。

1. 登录到 Azure 门户。 用户帐户必须是 Azure 订阅的所有者或参与者。

1. 选择“资源组”，然后选择“+ 创建”。

1. 选择订阅。

1. 在资源组中，输入 **rg-PostgreSQL_Replication**。

1. 选择靠近你所在位置的区域。

1. 选择“查看 + 创建”。

1. 选择“创建”。

## 创建发布服务器

在本部分中，你将创建发布服务器。 发布服务器是数据的源，这些数据将被复制到订阅服务器。

1. 在“Azure 服务”下，选择“+ 创建资源”。 在“类别”下，选择“数据库”。 在“Azure Database for PostgreSQL”下，选择“创建”。

1. 在灵活服务器“基本信息”选项卡上，输入每个字段，如下所示：
    - 订阅 - 你的订阅。
    - **资源组** - 选择 “**rg-PostgreSQL_Replication**”。
    - **服务器名称** - * psql-postgresql-pub9999*（名称必须全局唯一，请将 9999 替换为四位随机数字）。
    - 区域 - 选择与资源组相同的区域。
    - **PostgreSQL 版本** - 选择“16”。
    - **工作负荷类型** - *开发*。
    - **计算 + 存储** - *可突发*。 选择“配置服务器”并检查配置选项。 请勿进行任何更改并关闭该部分。
    - 可用性区域 - 1。 如果不支持可用性区域，请保留为“无首选项”。
    - **高可用性** - 禁用的。
    - **身份验证方法** - 只允许 PostgreSQL 身份验证。
    - 在**管理员用户名**中输入 **`pgAdmin`**。
    - 在**密码**中输入合适的复杂密码。

1. 选择“下一步: 网络 >”****。

1. 在灵活服务器“网络”选项卡上，输入每个字段，如下所示：
    - **连接方法**：(o) 公共访问（允许的 IP 地址）。
    - **允许 Azure 内任意 Azure 服务公开访问此服务器**：已选中。 必须选中此选复选框，确保发布服务器和订阅服务器数据库能够互相通信。
    - 在“**防火墙规则**”下，选择“**+ 添加当前客户端 IP 地址**”。 此选项会将当前 IP 地址添加为防火墙规则。 可以选择为此防火墙规则指定一个有意义的名称。

1. 选择“查看 + 创建”。 然后选择“创建”。

1. 由于创建 Azure Database for PostgreSQL 可能需要几分钟时间，因此请在进行部署时立即开始下一步。 请记得打开新的浏览器窗口或选项卡以继续。

## 创建订阅服务器

1. 在“Azure 服务”下，选择“+ 创建资源”。 在“类别”下，选择“数据库”。 在“Azure Database for PostgreSQL”下，选择“创建”。

1. 在灵活服务器“基本信息”选项卡上，输入每个字段，如下所示：
    - 订阅 - 你的订阅。
    - **资源组** - 选择 “**rg-PostgreSQL_Replication**”。
    - **服务器名称** - * psql-postgresql-sub9999*（名称必须全局唯一，请将 9999 替换为四位随机数字）。
    - 区域 - 选择与资源组相同的区域。
    - **PostgreSQL 版本** - 选择“16”。
    - **工作负荷类型** - *开发*。
    - **计算 + 存储** - *可突发*。 选择“配置服务器”并检查配置选项。 请勿进行任何更改并关闭该部分。
    - **可用性区域** - 2。 如果不支持可用性区域，请保留为“无首选项”。
    - **高可用性** - 禁用的。
    - **身份验证方法** - 只允许 PostgreSQL 身份验证。
    - 在**管理员用户名**中输入 **`pgAdmin`**。
    - 在**密码**中输入合适的复杂密码。

1. 选择“下一步: 网络 >”****。

1. 在灵活服务器“网络”选项卡上，输入每个字段，如下所示：
    - **连接方法**：(o) 公共访问（允许的 IP 地址）。
    - **允许 Azure 内任意 Azure 服务公开访问此服务器**：已选中。 必须选中此选复选框，确保发布服务器和订阅服务器数据库能够互相通信。
    - 在“**防火墙规则**”下，选择“**+ 添加当前客户端 IP 地址**”。 此选项会将当前 IP 地址添加为防火墙规则。 可以选择为此防火墙规则指定一个有意义的名称。

1. 选择“查看 + 创建”。 然后选择“创建”。

1. 等待部署这两个 Azure Database for PostgreSQL 服务器。

## 设置复制

对于这*两个*发布服务器和订阅服务器：

1. 在 Azure 门户中，导航到服务器，并在“设置”下选择“服务器参数”。

1. 使用搜索栏查找每个参数并进行以下更改：
    - `wal_level` = LOGICAL
    - `max_worker_processes` = 24

1. 选择“保存”。 然后选择“保存并重启”。

1. 等待两个服务器重启。

    > &#128221; 服务器重新部署后，可能需要刷新浏览器窗口，才能看到服务器已重启。

## 设置发布服务器

在本部分中，你将设置发布服务器。 发布服务器是数据的源，这些数据将被复制到订阅服务器。

1. 打开 Visual Studio Code 的第一个实例，连接到发布服务器。

1. 打开你克隆 GitHub 存储库的文件夹。

1. 在左侧菜单中选择 “**PostgreSQL**” 图标。

    > &#128221; 如果未看到 PostgreSQL 图标，请点击 “**扩展**” 图标并搜索 **PostgreSQL**。 选择 Microsoft 提供的 **PostgreSQL** 扩展，并点击“安装”****。

1. 如果你已连接 PostgreSQL *发布*服务器，请跳转到下一步。 要创建新连接：

    1. 在 **PostgreSQL** 扩展中，选择“**+ 添加连接**”，以添加新连接。

    1. 在“**新建连接**”对话框中，输入以下信息：

        - **服务器名称**：`<your-publisher-server-name>`.postgres.database.azure.com
        - 身份验证类型：密码
        - **用户名**：pgAdmin
        - **密码**：之前生成的随机密码。
        - 选中“**保存密码**”复选框。
        - **连接名称**：`<your-publisher-server-name>`

    1. 选择“**测试连接**”以测试连接。 如果连接成功，请选择“**保存并连接**”以保存连接，否则请查看连接信息，然后重试。

1. 如果尚未连接，请选择 PostgreSQL 服务器的“**连接**”。 已连接到 Azure Database for PostgreSQL 服务器。

1. 展开服务器节点及其数据库。 列出了现有数据库。

1. 在 Visual Studio Code 中，依次选择“**文件**”、“**打开文件**”，然后导航到脚本保存的文件夹。 选择 **../Allfiles/Labs/06/Lab6_Replication.sql**，然后“**打开**”。

1. 在 Visual Studio Code 右下角，确保连接为绿色。 如果不是，则应显示“**PGSQL 已断开连接**”。 选择“**PGSQL 已断开连接**”文本，然后从命令面板的列表中选择 PostgreSQL 服务器连接。 如果请求密码，请输入之前生成的密码。

1. 现在开始设置 *发布*。

    1. 突出显示并运行“授予管理员用户复制权限”部分。

    1. 突出显示并运行“创建 zoodb 数据库”部分。

    1. 如果仅突出显示 **SELECT current_database()** 语句并运行它，则会看到数据库当前设置为 `postgres`。 需要将其更改为 `zoodb`。

    1. 选择菜单栏中带有“*运行*”图标的省略号，然后选择“**更改 PostgreSQL 数据库**”。 从数据库列表中选择 `zoodb`。

        > &#128221; 还可以更改查询窗格上的数据库。 可以在查询选项卡本身下记下服务器名称和数据库名称。 选择数据库名称将显示数据库列表。 从列表中选择 `zoodb` 数据库。

    1. 突出显示并运行 zoodb 中的 **创建表** 和 **外键约束** 部分。

    1. 突出显示并运行“填充 zoodb 中的表”部分。

    1. 突出显示并运行“创建发布”部分。 运行 SELECT 语句时不会列出任何内容，因为复制尚未处于活动状态。

    1. 不要运行**创建订阅**部分。 此脚本在订阅服务器上运行。

    1. 请勿关闭此 Visual Studio Code 窗口，只需将其最小化。 设置订阅服务器完成后，再返回此窗口。

你已成功创建发布服务器和 zoodb 数据库。 数据库中包含将复制到订阅服务器的表和数据。

## 设置订阅者

在本部分中，你将设置订阅服务器。 订阅服务器是从发布服务器复制数据的目标。 在订阅服务器上创建新数据库，填充来自发布服务器的数据。

1. 打开 Visual Studio Code 的*第二个实例*，连接到订阅服务器。

1. 打开你克隆 GitHub 存储库的文件夹。

1. 在左侧菜单中选择 “**PostgreSQL**” 图标。

    > &#128221; 如果未看到 PostgreSQL 图标，请点击 “**扩展**” 图标并搜索 **PostgreSQL**。 选择 Microsoft 提供的 **PostgreSQL** 扩展，并点击“安装”****。

1. 如果你已连接 PostgreSQL *订阅*服务器，请跳转到下一步。 要创建新连接：

    1. 在 **PostgreSQL** 扩展中，选择“**+ 添加连接**”，以添加新连接。

    1. 在“**新建连接**”对话框中，输入以下信息：

        - **服务器名称**：`<your-subscriber-server-name>`.postgres.database.azure.com
        - 身份验证类型：密码
        - **用户名**：pgAdmin
        - **密码**：之前生成的随机密码。
        - 选中“**保存密码**”复选框。
        - **连接名称**：`<your-subscriber-server-name>`

    1. 选择“**测试连接**”以测试连接。 如果连接成功，请选择“**保存并连接**”以保存连接，否则请查看连接信息，然后重试。

1. 如果尚未连接，请选择 PostgreSQL 服务器的“**连接**”。 已连接到 Azure Database for PostgreSQL 服务器。

1. 展开服务器节点及其数据库。 列出了现有数据库。

1. 在 Visual Studio Code 中，依次选择“**文件**”、“**打开文件**”，然后导航到脚本保存的文件夹。 选择 **../Allfiles/Labs/06/Lab6_Replication.sql**，然后“**打开**”。

1. 在 Visual Studio Code 右下角，确保连接为绿色。 如果不是，则应显示“**PGSQL 已断开连接**”。 选择“**PGSQL 已断开连接**”文本，然后从命令面板的列表中选择 PostgreSQL 服务器连接。 如果请求密码，请输入之前生成的密码。

1. 现在开始设置*订阅服务器*。

    1. 突出显示并运行“授予管理员用户复制权限”部分。

    1. 突出显示并运行“创建 zoodb 数据库”部分。

    1. 如果仅突出显示 **SELECT current_database()** 语句并运行它，则会看到数据库当前设置为 `postgres`。 需要将其更改为 `zoodb`。

    1. 选择菜单栏中带有“*运行*”图标的省略号，然后选择“**更改 PostgreSQL 数据库**”。 从数据库列表中选择 `zoodb`。

        > &#128221; 还可以更改查询窗格上的数据库。 可以在查询选项卡本身下记下服务器名称和数据库名称。 选择数据库名称将显示数据库列表。 从列表中选择 `zoodb` 数据库。

    1. 突出显示并运行 `zoodb` 中的“**创建表**”和“**外键约束**”部分。

    1. 请勿运行“**创建发布**”部分，该语句已在发布服务器上运行。

    1. 向下滚动到“创建订阅”部分。

        1. 编辑 **创建订阅** 语句，使其包含正确的发布服务器名称和发布者的强密码。 突出显示并运行语句。

        1. 突出显示并运行 SELECT 语句。 这会显示之前创建的订阅“sub”。

    1. 在“**显示表**”部分，突出显示并运行每条 **SELECT** 语句。 发布服务器复制这些表的数据。

你已创建订阅服务器和 zoodb 数据库。 数据库包含已从发布服务器复制的表和数据。

## 对发布服务器数据库进行更改

- 在 Visual Studio Code 的第一个实例中（*即发布服务器实例*），在 **“插入更多动物”** 下，突出显示并运行 **INSERT** 语句。 *请确保 **不要** 在订阅者*运行此 INSERT 语句。

## 查看订阅服务器数据库中的更改

- 在 Visual Studio Code（订阅服务器）的第二个实例中，在“**显示动物表**”下突出显示并运行 **SELECT** 语句。

现已创建两个 Azure Database for PostgreSQL 灵活服务器，并将一个服务器配置为发布服务器，将另一个服务器配置为订阅服务器。 在发布服务器数据库中，你创建并填充了 zoo 数据库。 在订阅服务器数据库中，你创建了一个空数据库，然后通过流式处理复制填充该数据库。

## 清理

1. 如果不再需要此 PostgreSQL 服务器进行其他练习，若要避免产生不必要的 Azure 成本，请删除在本练习中创建的资源组。

1. 如果想让 PostgreSQL 服务器继续运行，可以保持其开启状态。 否则，可以在 bash 终端停止服务器，避免产生不必要的费用。 运行以下命令，以停止每个服务器：

    ```bash

    ```azurecli
    az postgres flexible-server stop --name <your-server-name> --resource-group $RG_NAME
    ```

    将 `<your-server-name>` 替换为你的 PostgreSQL 服务器名称。

    > &#128221; 你也可以从 Azure 门户停止服务器。 在 Azure 门户中，导航到**资源组**，选择之前创建的资源组。 选择 PostgreSQL 服务器，然后从菜单中选择“停止”****。 对发布服务器和订阅服务器都执行此操作。

1. 如果需要，请删除之前克隆的 Git 存储库。

你已成功创建 PostgreSQL 服务器，并完成逻辑复制配置。 你已创建发布服务器和订阅服务器，并设置了了它们之间的复制。 你更新了发布数据库，并在订阅数据库中观察到了相应变化。 现在，你已经掌握了如何在 PostgreSQL 中配置逻辑复制。
